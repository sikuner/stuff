
#include "common.h"
#include "conf.h"
#include <stdbool.h>
#include <stdio.h>

typedef struct tagBatteryVoltageCapacity { 
	
	double voltage;
	double capacity;
	
} BatteryVoltageCapacity;

#define BATTERY_CHARGE_MAX				2000.0
#define BATTERY_CHARGE_CAPACITY			2068.1
#define BATTERY_DISCHARGE_CAPACITY		2134.3

static BatteryVoltageCapacity battery_charge_curve[] = {
	
	{ 6.749 , 0 	 } ,
	{ 6.798 , 3.1	 } ,
	{ 6.849 , 8.7	 } ,
	{ 6.891 , 16	 } ,
	{ 6.923 , 23.3	 } ,
	{ 6.952 , 30.7	 } ,
	{ 6.977 , 38	 } ,
	{ 6.999 , 45.3	 } ,
	{ 7.02	, 52.6	 } ,
	{ 7.037 , 60	 } ,
	{ 7.056 , 67.3	 } ,
	{ 7.073 , 74.6	 } ,
	{ 7.088 , 81.9	 } ,
	{ 7.101 , 89.3	 } ,
	{ 7.111 , 96.6	 } ,
	{ 7.119 , 103.9  } ,
	{ 7.128 , 111.2  } ,
	{ 7.134 , 118.6  } ,
	{ 7.14	, 125.9  } ,
	{ 7.147 , 133.2  } ,
	{ 7.153 , 140.6  } ,
	{ 7.16	, 147.9  } ,
	{ 7.165 , 155.2  } ,
	{ 7.171 , 162.5  } ,
	{ 7.178 , 169.9  } ,
	{ 7.183 , 177.2  } ,
	{ 7.19	, 184.5  } ,
	{ 7.196 , 191.8  } ,
	{ 7.201 , 199.2  } ,
	{ 7.207 , 206.5  } ,
	{ 7.214 , 213.8  } ,
	{ 7.22	, 221.1  } ,
	{ 7.225 , 228.5  } ,
	{ 7.23	, 235.8  } ,
	{ 7.236 , 243.1  } ,
	{ 7.242 , 250.5  } ,
	{ 7.247 , 257.8  } ,
	{ 7.253 , 265.1  } ,
	{ 7.258 , 272.4  } ,
	{ 7.264 , 279.8  } ,
	{ 7.271 , 287.1  } ,
	{ 7.276 , 294.4  } ,
	{ 7.281 , 301.7  } ,
	{ 7.285 , 309.1  } ,
	{ 7.29	, 316.4  } ,
	{ 7.295 , 323.7  } ,
	{ 7.302 , 331	 } ,
	{ 7.307 , 338.4  } ,
	{ 7.312 , 345.7  } ,
	{ 7.316 , 353	 } ,
	{ 7.32	, 360.4  } ,
	{ 7.325 , 367.7  } ,
	{ 7.33	, 375	 } ,
	{ 7.335 , 382.3  } ,
	{ 7.339 , 389.7  } ,
	{ 7.344 , 397	 } ,
	{ 7.347 , 404.3  } ,
	{ 7.351 , 411.6  } ,
	{ 7.356 , 419	 } ,
	{ 7.36	, 426.3  } ,
	{ 7.364 , 433.6  } ,
	{ 7.367 , 441	 } ,
	{ 7.371 , 448.3  } ,
	{ 7.375 , 455.6  } ,
	{ 7.378 , 462.9  } ,
	{ 7.381 , 470.3  } ,
	{ 7.386 , 477.6  } ,
	{ 7.39	, 484.9  } ,
	{ 7.392 , 492.2  } ,
	{ 7.396 , 499.6  } ,
	{ 7.398 , 506.9  } ,
	{ 7.402 , 514.2  } ,
	{ 7.405 , 521.5  } ,
	{ 7.407 , 528.9  } ,
	{ 7.411 , 536.2  } ,
	{ 7.414 , 543.5  } ,
	{ 7.418 , 550.9  } ,
	{ 7.421 , 558.2  } ,
	{ 7.424 , 565.5  } ,
	{ 7.427 , 572.8  } ,
	{ 7.431 , 580.2  } ,
	{ 7.433 , 587.5  } ,
	{ 7.437 , 594.8  } ,
	{ 7.442 , 602.1  } ,
	{ 7.444 , 609.5  } ,
	{ 7.448 , 616.8  } ,
	{ 7.452 , 624.1  } ,
	{ 7.455 , 631.4  } ,
	{ 7.458 , 638.8  } ,
	{ 7.462 , 646.1  } ,
	{ 7.465 , 653.4  } ,
	{ 7.47	, 660.8  } ,
	{ 7.474 , 668.1  } ,
	{ 7.478 , 675.4  } ,
	{ 7.481 , 682.7  } ,
	{ 7.485 , 690.1  } ,
	{ 7.489 , 697.4  } ,
	{ 7.494 , 704.7  } ,
	{ 7.498 , 712	 } ,
	{ 7.502 , 719.4  } ,
	{ 7.507 , 726.7  } ,
	{ 7.511 , 734	 } ,
	{ 7.516 , 741.4  } ,
	{ 7.52	, 748.7  } ,
	{ 7.525 , 756	 } ,
	{ 7.531 , 763.3  } ,
	{ 7.535 , 770.7  } ,
	{ 7.54	, 778	 } ,
	{ 7.545 , 785.3  } ,
	{ 7.55	, 792.6  } ,
	{ 7.555 , 800	 } ,
	{ 7.561 , 807.3  } ,
	{ 7.566 , 814.6  } ,
	{ 7.571 , 821.9  } ,
	{ 7.576 , 829.3  } ,
	{ 7.581 , 836.6  } ,
	{ 7.587 , 843.9  } ,
	{ 7.593 , 851.3  } ,
	{ 7.598 , 858.6  } ,
	{ 7.603 , 865.9  } ,
	{ 7.609 , 873.2  } ,
	{ 7.615 , 880.6  } ,
	{ 7.622 , 887.9  } ,
	{ 7.628 , 895.2  } ,
	{ 7.633 , 902.5  } ,
	{ 7.639 , 909.9  } ,
	{ 7.646 , 917.2  } ,
	{ 7.653 , 924.5  } ,
	{ 7.659 , 931.8  } ,
	{ 7.664 , 939.2  } ,
	{ 7.671 , 946.5  } ,
	{ 7.677 , 953.8  } ,
	{ 7.684 , 961.2  } ,
	{ 7.69	, 968.5  } ,
	{ 7.696 , 975.8  } ,
	{ 7.703 , 983.1  } ,
	{ 7.71	, 990.5  } ,
	{ 7.716 , 997.8  } ,
	{ 7.722 , 1005.1 } ,
	{ 7.731 , 1012.4 } ,
	{ 7.736 , 1019.8 } ,
	{ 7.743 , 1027.1 } ,
	{ 7.749 , 1034.4 } ,
	{ 7.754 , 1041.7 } ,
	{ 7.762 , 1049.1 } ,
	{ 7.768 , 1056.4 } ,
	{ 7.774 , 1063.7 } ,
	{ 7.78	, 1071.1 } ,
	{ 7.788 , 1078.4 } ,
	{ 7.794 , 1085.7 } ,
	{ 7.8	, 1093	 } ,
	{ 7.805 , 1100.4 } ,
	{ 7.811 , 1107.7 } ,
	{ 7.819 , 1115	 } ,
	{ 7.824 , 1122.3 } ,
	{ 7.83	, 1129.7 } ,
	{ 7.835 , 1137	 } ,
	{ 7.841 , 1144.3 } ,
	{ 7.847 , 1151.7 } ,
	{ 7.853 , 1159	 } ,
	{ 7.858 , 1166.3 } ,
	{ 7.863 , 1173.6 } ,
	{ 7.868 , 1181	 } ,
	{ 7.875 , 1188.3 } ,
	{ 7.881 , 1195.6 } ,
	{ 7.886 , 1202.9 } ,
	{ 7.891 , 1210.3 } ,
	{ 7.896 , 1217.6 } ,
	{ 7.902 , 1224.9 } ,
	{ 7.907 , 1232.2 } ,
	{ 7.912 , 1239.6 } ,
	{ 7.917 , 1246.9 } ,
	{ 7.922 , 1254.2 } ,
	{ 7.927 , 1261.6 } ,
	{ 7.933 , 1268.9 } ,
	{ 7.938 , 1276.2 } ,
	{ 7.941 , 1283.5 } ,
	{ 7.946 , 1290.9 } ,
	{ 7.951 , 1298.2 } ,
	{ 7.955 , 1305.5 } ,
	{ 7.961 , 1312.8 } ,
	{ 7.966 , 1320.2 } ,
	{ 7.971 , 1327.5 } ,
	{ 7.975 , 1334.8 } ,
	{ 7.98	, 1342.1 } ,
	{ 7.986 , 1349.5 } ,
	{ 7.991 , 1356.8 } ,
	{ 7.996 , 1364.1 } ,
	{ 8.001 , 1371.5 } ,
	{ 8.006 , 1378.8 } ,
	{ 8.011 , 1386.1 } ,
	{ 8.017 , 1393.4 } ,
	{ 8.022 , 1400.8 } ,
	{ 8.027 , 1408.1 } ,
	{ 8.032 , 1415.4 } ,
	{ 8.038 , 1422.7 } ,
	{ 8.044 , 1430.1 } ,
	{ 8.051 , 1437.4 } ,
	{ 8.056 , 1444.7 } ,
	{ 8.062 , 1452.1 } ,
	{ 8.067 , 1459.4 } ,
	{ 8.074 , 1466.7 } ,
	{ 8.08	, 1474	 } ,
	{ 8.085 , 1481.4 } ,
	{ 8.092 , 1488.7 } ,
	{ 8.098 , 1496	 } ,
	{ 8.105 , 1503.3 } ,
	{ 8.111 , 1510.7 } ,
	{ 8.116 , 1518	 } ,
	{ 8.124 , 1525.3 } ,
	{ 8.13	, 1532.7 } ,
	{ 8.136 , 1540	 } ,
	{ 8.142 , 1547.3 } ,
	{ 8.149 , 1554.6 } ,
	{ 8.155 , 1562	 } ,
	{ 8.162 , 1569.3 } ,
	{ 8.167 , 1576.6 } ,
	{ 8.173 , 1583.9 } ,
	{ 8.18	, 1591.3 } ,
	{ 8.186 , 1598.6 } ,
	{ 8.192 , 1605.9 } ,
	{ 8.197 , 1613.3 } ,
	{ 8.202 , 1620.6 } ,
	{ 8.207 , 1627.9 } ,
	{ 8.212 , 1635.2 } ,
	{ 8.218 , 1642.6 } ,
	{ 8.223 , 1649.9 } ,
	{ 8.227 , 1657.2 } ,
	{ 8.232 , 1664.5 } ,
	{ 8.235 , 1671.9 } ,
	{ 8.24	, 1679.2 } ,
	{ 8.245 , 1686.5 } ,
	{ 8.249 , 1693.8 } ,
	{ 8.254 , 1701.2 } ,
	{ 8.258 , 1708.5 } ,
	{ 8.263 , 1715.8 } ,
	{ 8.266 , 1723.2 } ,
	{ 8.273 , 1730.5 } ,
	{ 8.276 , 1737.8 } ,
	{ 8.281 , 1745.1 } ,
	{ 8.285 , 1752.5 } ,
	{ 8.29	, 1759.8 } ,
	{ 8.294 , 1767.1 } ,
	{ 8.3	, 1774.4 } ,
	{ 8.305 , 1781.8 } ,
	{ 8.31	, 1789.1 } ,
	{ 8.313 , 1796.4 } ,
	{ 8.318 , 1803.8 } ,
	{ 8.323 , 1811.1 } ,
	{ 8.33	, 1818.4 } ,
	{ 8.335 , 1825.7 } ,
	{ 8.34	, 1833.1 } ,
	{ 8.344 , 1840.4 } ,
	{ 8.351 , 1847.7 } ,
	{ 8.356 , 1855	 } ,
	{ 8.362 , 1862.4 } ,
	{ 8.368 , 1869.7 } ,
	{ 8.373 , 1877	 } ,
	{ 8.379 , 1884.3 } ,
	{ 8.397 , 1891.7 } ,
	{ 8.403 , 1899	 } ,
	{ 8.399 , 1906.3 } ,
	{ 8.4	, 1913.5 } ,
	
};

static BatteryVoltageCapacity battery_discharge_curve[] = {
	
	{ 8.282 , 0 	 } , 
	{ 8.28	, 7.3	 } , 
	{ 8.26	, 14.7	 } , 
	{ 8.247 , 22	 } , 
	{ 8.232 , 29.3	 } , 
	{ 8.22	, 36.6	 } , 
	{ 8.208 , 44	 } , 
	{ 8.198 , 51.3	 } , 
	{ 8.188 , 58.6	 } , 
	{ 8.177 , 65.9	 } , 
	{ 8.167 , 73.3	 } , 
	{ 8.158 , 80.6	 } , 
	{ 8.149 , 87.9	 } , 
	{ 8.14	, 95.2	 } , 
	{ 8.131 , 102.6  } , 
	{ 8.121 , 109.9  } , 
	{ 8.113 , 117.2  } , 
	{ 8.105 , 124.6  } , 
	{ 8.095 , 131.9  } , 
	{ 8.088 , 139.2  } , 
	{ 8.08	, 146.5  } , 
	{ 8.073 , 153.9  } , 
	{ 8.064 , 161.2  } , 
	{ 8.058 , 168.5  } , 
	{ 8.051 , 175.8  } , 
	{ 8.044 , 183.2  } , 
	{ 8.036 , 190.5  } , 
	{ 8.03	, 197.8  } , 
	{ 8.023 , 205.2  } , 
	{ 8.017 , 212.5  } , 
	{ 8.01	, 219.8  } , 
	{ 8.005 , 227.1  } , 
	{ 7.999 , 234.5  } , 
	{ 7.992 , 241.8  } , 
	{ 7.987 , 249.1  } , 
	{ 7.981 , 256.4  } , 
	{ 7.976 , 263.8  } , 
	{ 7.971 , 271.1  } , 
	{ 7.966 , 278.4  } , 
	{ 7.961 , 285.7  } , 
	{ 7.955 , 293.1  } , 
	{ 7.95	, 300.4  } , 
	{ 7.945 , 307.7  } , 
	{ 7.94	, 315.1  } , 
	{ 7.935 , 322.4  } , 
	{ 7.932 , 329.7  } , 
	{ 7.925 , 337	 } , 
	{ 7.919 , 344.4  } , 
	{ 7.914 , 351.7  } , 
	{ 7.909 , 359	 } , 
	{ 7.904 , 366.3  } , 
	{ 7.898 , 373.7  } , 
	{ 7.893 , 381	 } , 
	{ 7.887 , 388.3  } , 
	{ 7.882 , 395.6  } , 
	{ 7.876 , 403	 } , 
	{ 7.87	, 410.3  } , 
	{ 7.863 , 417.6  } , 
	{ 7.858 , 425	 } , 
	{ 7.852 , 432.3  } , 
	{ 7.846 , 439.6  } , 
	{ 7.84	, 446.9  } , 
	{ 7.834 , 454.3  } , 
	{ 7.827 , 461.6  } , 
	{ 7.822 , 468.9  } , 
	{ 7.816 , 476.2  } , 
	{ 7.81	, 483.6  } , 
	{ 7.804 , 490.9  } , 
	{ 7.798 , 498.2  } , 
	{ 7.793 , 505.6  } , 
	{ 7.786 , 512.9  } , 
	{ 7.78	, 520.2  } , 
	{ 7.774 , 527.5  } , 
	{ 7.769 , 534.9  } , 
	{ 7.763 , 542.2  } , 
	{ 7.758 , 549.5  } , 
	{ 7.752 , 556.8  } , 
	{ 7.746 , 564.2  } , 
	{ 7.741 , 571.5  } , 
	{ 7.736 , 578.8  } , 
	{ 7.731 , 586.1  } , 
	{ 7.724 , 593.5  } , 
	{ 7.718 , 600.8  } , 
	{ 7.715 , 608.1  } , 
	{ 7.71	, 615.5  } , 
	{ 7.705 , 622.8  } , 
	{ 7.7	, 630.1  } , 
	{ 7.693 , 637.4  } , 
	{ 7.69	, 644.8  } , 
	{ 7.685 , 652.1  } , 
	{ 7.68	, 659.4  } , 
	{ 7.676 , 666.7  } , 
	{ 7.671 , 674.1  } , 
	{ 7.666 , 681.4  } , 
	{ 7.661 , 688.7  } , 
	{ 7.657 , 696	 } , 
	{ 7.653 , 703.4  } , 
	{ 7.648 , 710.7  } , 
	{ 7.644 , 718	 } , 
	{ 7.638 , 725.4  } , 
	{ 7.634 , 732.7  } , 
	{ 7.629 , 740	 } , 
	{ 7.625 , 747.3  } , 
	{ 7.62	, 754.7  } , 
	{ 7.617 , 762	 } , 
	{ 7.61	, 769.3  } , 
	{ 7.607 , 776.6  } , 
	{ 7.602 , 784	 } , 
	{ 7.597 , 791.3  } , 
	{ 7.593 , 798.6  } , 
	{ 7.588 , 806	 } , 
	{ 7.583 , 813.3  } , 
	{ 7.578 , 820.6  } , 
	{ 7.573 , 827.9  } , 
	{ 7.569 , 835.3  } , 
	{ 7.564 , 842.6  } , 
	{ 7.56	, 849.9  } , 
	{ 7.555 , 857.2  } , 
	{ 7.55	, 864.6  } , 
	{ 7.545 , 871.9  } , 
	{ 7.541 , 879.2  } , 
	{ 7.536 , 886.5  } , 
	{ 7.531 , 893.9  } , 
	{ 7.525 , 901.2  } , 
	{ 7.52	, 908.5  } , 
	{ 7.515 , 915.9  } , 
	{ 7.51	, 923.2  } , 
	{ 7.505 , 930.5  } , 
	{ 7.5	, 937.8  } , 
	{ 7.494 , 945.2  } , 
	{ 7.489 , 952.5  } , 
	{ 7.484 , 959.8  } , 
	{ 7.478 , 967.1  } , 
	{ 7.473 , 974.5  } , 
	{ 7.467 , 981.8  } , 
	{ 7.462 , 989.1  } , 
	{ 7.457 , 996.4  } , 
	{ 7.45	, 1003.8 } , 
	{ 7.445 , 1011.1 } , 
	{ 7.438 , 1018.4 } , 
	{ 7.433 , 1025.8 } , 
	{ 7.428 , 1033.1 } , 
	{ 7.422 , 1040.4 } , 
	{ 7.417 , 1047.7 } , 
	{ 7.409 , 1055.1 } , 
	{ 7.405 , 1062.4 } , 
	{ 7.398 , 1069.7 } , 
	{ 7.393 , 1077	 } , 
	{ 7.387 , 1084.4 } , 
	{ 7.381 , 1091.7 } , 
	{ 7.376 , 1099	 } , 
	{ 7.37	, 1106.4 } , 
	{ 7.365 , 1113.7 } , 
	{ 7.359 , 1121	 } , 
	{ 7.352 , 1128.3 } , 
	{ 7.347 , 1135.7 } , 
	{ 7.341 , 1143	 } , 
	{ 7.336 , 1150.3 } , 
	{ 7.331 , 1157.6 } , 
	{ 7.325 , 1165	 } , 
	{ 7.319 , 1172.3 } , 
	{ 7.314 , 1179.6 } , 
	{ 7.309 , 1186.9 } , 
	{ 7.304 , 1194.3 } , 
	{ 7.299 , 1201.6 } , 
	{ 7.293 , 1208.9 } , 
	{ 7.288 , 1216.3 } , 
	{ 7.283 , 1223.6 } , 
	{ 7.278 , 1230.9 } , 
	{ 7.273 , 1238.2 } , 
	{ 7.267 , 1245.6 } , 
	{ 7.263 , 1252.9 } , 
	{ 7.258 , 1260.2 } , 
	{ 7.253 , 1267.5 } , 
	{ 7.25	, 1274.9 } , 
	{ 7.245 , 1282.2 } , 
	{ 7.24	, 1289.5 } , 
	{ 7.235 , 1296.9 } , 
	{ 7.231 , 1304.2 } , 
	{ 7.226 , 1311.5 } , 
	{ 7.222 , 1318.8 } , 
	{ 7.219 , 1326.2 } , 
	{ 7.214 , 1333.5 } , 
	{ 7.209 , 1340.8 } , 
	{ 7.205 , 1348.1 } , 
	{ 7.201 , 1355.5 } , 
	{ 7.197 , 1362.8 } , 
	{ 7.194 , 1370.1 } , 
	{ 7.19	, 1377.4 } , 
	{ 7.186 , 1384.8 } , 
	{ 7.181 , 1392.1 } , 
	{ 7.178 , 1399.4 } , 
	{ 7.174 , 1406.8 } , 
	{ 7.17	, 1414.1 } , 
	{ 7.166 , 1421.4 } , 
	{ 7.164 , 1428.7 } , 
	{ 7.16	, 1436.1 } , 
	{ 7.156 , 1443.4 } , 
	{ 7.152 , 1450.7 } , 
	{ 7.149 , 1458	 } , 
	{ 7.145 , 1465.4 } , 
	{ 7.142 , 1472.7 } , 
	{ 7.138 , 1480	 } , 
	{ 7.135 , 1487.3 } , 
	{ 7.132 , 1494.7 } , 
	{ 7.128 , 1502	 } , 
	{ 7.124 , 1509.3 } , 
	{ 7.121 , 1516.7 } , 
	{ 7.117 , 1524	 } , 
	{ 7.114 , 1531.3 } , 
	{ 7.111 , 1538.6 } , 
	{ 7.107 , 1546	 } , 
	{ 7.104 , 1553.3 } , 
	{ 7.101 , 1560.6 } , 
	{ 7.096 , 1567.9 } , 
	{ 7.092 , 1575.3 } , 
	{ 7.09	, 1582.6 } , 
	{ 7.086 , 1589.9 } , 
	{ 7.082 , 1597.3 } , 
	{ 7.078 , 1604.6 } , 
	{ 7.075 , 1611.9 } , 
	{ 7.071 , 1619.2 } , 
	{ 7.066 , 1626.6 } , 
	{ 7.062 , 1633.9 } , 
	{ 7.059 , 1641.2 } , 
	{ 7.055 , 1648.5 } , 
	{ 7.051 , 1655.9 } , 
	{ 7.047 , 1663.2 } , 
	{ 7.044 , 1670.5 } , 
	{ 7.039 , 1677.8 } , 
	{ 7.035 , 1685.2 } , 
	{ 7.03	, 1692.5 } , 
	{ 7.026 , 1699.8 } , 
	{ 7.023 , 1707.2 } , 
	{ 7.018 , 1714.5 } , 
	{ 7.014 , 1721.8 } , 
	{ 7.008 , 1729.1 } , 
	{ 7.003 , 1736.5 } , 
	{ 6.999 , 1743.8 } , 
	{ 6.994 , 1751.1 } , 
	{ 6.989 , 1758.4 } , 
	{ 6.985 , 1765.8 } , 
	{ 6.979 , 1773.1 } , 
	{ 6.975 , 1780.4 } , 
	{ 6.97	, 1787.8 } , 
	{ 6.966 , 1795.1 } , 
	{ 6.962 , 1802.4 } , 
	{ 6.957 , 1809.7 } , 
	{ 6.952 , 1817.1 } , 
	{ 6.947 , 1824.4 } , 
	{ 6.943 , 1831.7 } , 
	{ 6.938 , 1839	 } , 
	{ 6.933 , 1846.4 } , 
	{ 6.928 , 1853.7 } , 
	{ 6.923 , 1861	 } , 
	{ 6.918 , 1868.3 } , 
	{ 6.913 , 1875.7 } , 
	{ 6.908 , 1883	 } , 
	{ 6.905 , 1890.3 } , 
	{ 6.9	, 1897.7 } , 
	{ 6.894 , 1905	 } , 
	{ 6.889 , 1912.3 } , 
	{ 6.882 , 1919.6 } , 
	{ 6.877 , 1927	 } , 
	{ 6.871 , 1934.3 } , 
	{ 6.865 , 1941.6 } , 
	{ 6.859 , 1948.9 } , 
	{ 6.853 , 1956.3 } , 
	{ 6.845 , 1963.6 } , 
	{ 6.837 , 1970.9 } , 
	{ 6.827 , 1978.3 } , 
	{ 6.817 , 1985.6 } , 
	{ 6.804 , 1992.9 } , 
	{ 6.792 , 2000.2 } , 
	{ 6.776 , 2007.6 } , 
	{ 6.76	, 2014.9 } , 
	{ 6.741 , 2022.2 } , 
	{ 6.721 , 2029.5 } , 
	{ 6.7	, 2036.9 } , 
	{ 6.677 , 2044.2 } , 
	{ 6.652 , 2051.5 } , 
	{ 6.625 , 2058.8 } , 
	{ 6.595 , 2066.2 } , 
	{ 6.563 , 2073.5 } , 
	{ 6.527 , 2080.8 } , 
	{ 6.487 , 2088.2 } , 
	{ 6.442 , 2095.5 } , 
	{ 6.391 , 2102.4 } , 
	{ 6.341 , 2108.8 } , 
	{ 6.288 , 2114.5 } , 
	{ 6.236 , 2119.2 } , 
	{ 6.184 , 2123.2 } , 
	{ 6.133 , 2126.5 } , 
	{ 6.083 , 2129.4 } , 
	{ 6.029 , 2132.5 } , 
	{ 5.998 , 2134.3 } , 
	
};

static char *battery_charge_icon[101] = { 
	
	[0]   = ICON_BATTERY_C0,
	[1]   = ICON_BATTERY_C0,
	[2]   = ICON_BATTERY_C0,
	[3]   = ICON_BATTERY_C0,
	[4]   = ICON_BATTERY_C0,
	[5]   = ICON_BATTERY_C1,
	[6]   = ICON_BATTERY_C1,
	[7]   = ICON_BATTERY_C1,
	[8]   = ICON_BATTERY_C1,
	[9]   = ICON_BATTERY_C1,
	
	[10]  = ICON_BATTERY_C2,
	[11]  = ICON_BATTERY_C2,
	[12]  = ICON_BATTERY_C2,
	[13]  = ICON_BATTERY_C2,
	[14]  = ICON_BATTERY_C2,
	[15]  = ICON_BATTERY_C2,
	[16]  = ICON_BATTERY_C2,
	[17]  = ICON_BATTERY_C2,
	[18]  = ICON_BATTERY_C2,
	[19]  = ICON_BATTERY_C2,
	
	[20]  = ICON_BATTERY_C3,
	[21]  = ICON_BATTERY_C3,
	[22]  = ICON_BATTERY_C3,
	[23]  = ICON_BATTERY_C3,
	[24]  = ICON_BATTERY_C3,
	[25]  = ICON_BATTERY_C3,
	[26]  = ICON_BATTERY_C3,
	[27]  = ICON_BATTERY_C3,
	[28]  = ICON_BATTERY_C3,
	[29]  = ICON_BATTERY_C3,
	
	[30]  = ICON_BATTERY_C4,
	[31]  = ICON_BATTERY_C4,
	[32]  = ICON_BATTERY_C4,
	[33]  = ICON_BATTERY_C4,
	[34]  = ICON_BATTERY_C4,
	[35]  = ICON_BATTERY_C4,
	[36]  = ICON_BATTERY_C4,
	[37]  = ICON_BATTERY_C4,
	[38]  = ICON_BATTERY_C4,
	[39]  = ICON_BATTERY_C4,
	
	[40]  = ICON_BATTERY_C5,
	[41]  = ICON_BATTERY_C5,
	[42]  = ICON_BATTERY_C5,
	[43]  = ICON_BATTERY_C5,
	[44]  = ICON_BATTERY_C5,
	[45]  = ICON_BATTERY_C5,
	[46]  = ICON_BATTERY_C5,
	[47]  = ICON_BATTERY_C5,
	[48]  = ICON_BATTERY_C5,
	[49]  = ICON_BATTERY_C5,
	
	[50]  = ICON_BATTERY_C6,
	[51]  = ICON_BATTERY_C6,
	[52]  = ICON_BATTERY_C6,
	[53]  = ICON_BATTERY_C6,
	[54]  = ICON_BATTERY_C6,
	[55]  = ICON_BATTERY_C6,
	[56]  = ICON_BATTERY_C6,
	[57]  = ICON_BATTERY_C6,
	[58]  = ICON_BATTERY_C6,
	[59]  = ICON_BATTERY_C6,
	
	[60]  = ICON_BATTERY_C7,
	[61]  = ICON_BATTERY_C7,
	[62]  = ICON_BATTERY_C7,
	[63]  = ICON_BATTERY_C7,
	[64]  = ICON_BATTERY_C7,
	[65]  = ICON_BATTERY_C7,
	[66]  = ICON_BATTERY_C7,
	[67]  = ICON_BATTERY_C7,
	[68]  = ICON_BATTERY_C7,
	[69]  = ICON_BATTERY_C7,
	
	[70]  = ICON_BATTERY_C8,
	[71]  = ICON_BATTERY_C8,
	[72]  = ICON_BATTERY_C8,
	[73]  = ICON_BATTERY_C8,
	[74]  = ICON_BATTERY_C8,
	[75]  = ICON_BATTERY_C8,
	[76]  = ICON_BATTERY_C8,
	[77]  = ICON_BATTERY_C8,
	[78]  = ICON_BATTERY_C8,
	[79]  = ICON_BATTERY_C8,
	
	[80]  = ICON_BATTERY_C9,
	[81]  = ICON_BATTERY_C9,
	[82]  = ICON_BATTERY_C9,
	[83]  = ICON_BATTERY_C9,
	[84]  = ICON_BATTERY_C9,
	[85]  = ICON_BATTERY_C9,
	[86]  = ICON_BATTERY_C9,
	[87]  = ICON_BATTERY_C9,
	[88]  = ICON_BATTERY_C9,
	[89]  = ICON_BATTERY_C9,
	
	[90]  = ICON_BATTERY_C10,
	[91]  = ICON_BATTERY_C10,
	[92]  = ICON_BATTERY_C10,
	[93]  = ICON_BATTERY_C10,
	[94]  = ICON_BATTERY_C10,
	[95]  = ICON_BATTERY_C11,
	[96]  = ICON_BATTERY_C11,
	[97]  = ICON_BATTERY_C11,
	[98]  = ICON_BATTERY_C11,
	[99]  = ICON_BATTERY_C11,
	
	[100] = ICON_BATTERY_C11
	
};

static char *battery_discharge_icon[101] = { 
	
	[0]   = ICON_BATTERY_0,
	[1]   = ICON_BATTERY_0,
	[2]   = ICON_BATTERY_0,
	[3]   = ICON_BATTERY_0,
	[4]   = ICON_BATTERY_0,
	[5]   = ICON_BATTERY_1,
	[6]   = ICON_BATTERY_1,
	[7]   = ICON_BATTERY_1,
	[8]   = ICON_BATTERY_1,
	[9]   = ICON_BATTERY_1,
	
	[10]  = ICON_BATTERY_2,
	[11]  = ICON_BATTERY_2,
	[12]  = ICON_BATTERY_2,
	[13]  = ICON_BATTERY_2,
	[14]  = ICON_BATTERY_2,
	[15]  = ICON_BATTERY_2,
	[16]  = ICON_BATTERY_2,
	[17]  = ICON_BATTERY_2,
	[18]  = ICON_BATTERY_2,
	[19]  = ICON_BATTERY_2,
	
	[20]  = ICON_BATTERY_3,
	[21]  = ICON_BATTERY_3,
	[22]  = ICON_BATTERY_3,
	[23]  = ICON_BATTERY_3,
	[24]  = ICON_BATTERY_3,
	[25]  = ICON_BATTERY_3,
	[26]  = ICON_BATTERY_3,
	[27]  = ICON_BATTERY_3,
	[28]  = ICON_BATTERY_3,
	[29]  = ICON_BATTERY_3,
	
	[30]  = ICON_BATTERY_4,
	[31]  = ICON_BATTERY_4,
	[32]  = ICON_BATTERY_4,
	[33]  = ICON_BATTERY_4,
	[34]  = ICON_BATTERY_4,
	[35]  = ICON_BATTERY_4,
	[36]  = ICON_BATTERY_4,
	[37]  = ICON_BATTERY_4,
	[38]  = ICON_BATTERY_4,
	[39]  = ICON_BATTERY_4,
	
	[40]  = ICON_BATTERY_5,
	[41]  = ICON_BATTERY_5,
	[42]  = ICON_BATTERY_5,
	[43]  = ICON_BATTERY_5,
	[44]  = ICON_BATTERY_5,
	[45]  = ICON_BATTERY_5,
	[46]  = ICON_BATTERY_5,
	[47]  = ICON_BATTERY_5,
	[48]  = ICON_BATTERY_5,
	[49]  = ICON_BATTERY_5,
	
	[50]  = ICON_BATTERY_6,
	[51]  = ICON_BATTERY_6,
	[52]  = ICON_BATTERY_6,
	[53]  = ICON_BATTERY_6,
	[54]  = ICON_BATTERY_6,
	[55]  = ICON_BATTERY_6,
	[56]  = ICON_BATTERY_6,
	[57]  = ICON_BATTERY_6,
	[58]  = ICON_BATTERY_6,
	[59]  = ICON_BATTERY_6,
	
	[60]  = ICON_BATTERY_7,
	[61]  = ICON_BATTERY_7,
	[62]  = ICON_BATTERY_7,
	[63]  = ICON_BATTERY_7,
	[64]  = ICON_BATTERY_7,
	[65]  = ICON_BATTERY_7,
	[66]  = ICON_BATTERY_7,
	[67]  = ICON_BATTERY_7,
	[68]  = ICON_BATTERY_7,
	[69]  = ICON_BATTERY_7,
	
	[70]  = ICON_BATTERY_8,
	[71]  = ICON_BATTERY_8,
	[72]  = ICON_BATTERY_8,
	[73]  = ICON_BATTERY_8,
	[74]  = ICON_BATTERY_8,
	[75]  = ICON_BATTERY_8,
	[76]  = ICON_BATTERY_8,
	[77]  = ICON_BATTERY_8,
	[78]  = ICON_BATTERY_8,
	[79]  = ICON_BATTERY_8,
	
	[80]  = ICON_BATTERY_9,
	[81]  = ICON_BATTERY_9,
	[82]  = ICON_BATTERY_9,
	[83]  = ICON_BATTERY_9,
	[84]  = ICON_BATTERY_9,
	[85]  = ICON_BATTERY_10,
	[86]  = ICON_BATTERY_10,
	[87]  = ICON_BATTERY_10,
	[88]  = ICON_BATTERY_10,
	[89]  = ICON_BATTERY_10,
	
	[90]  = ICON_BATTERY_11,
	[91]  = ICON_BATTERY_11,
	[92]  = ICON_BATTERY_11,
	[93]  = ICON_BATTERY_11,
	[94]  = ICON_BATTERY_11,
	[95]  = ICON_BATTERY_11,
	[96]  = ICON_BATTERY_11,
	[97]  = ICON_BATTERY_11,
	[98]  = ICON_BATTERY_11,
	[99]  = ICON_BATTERY_11,
	
	[100] = ICON_BATTERY_11
	
};

/*
 * 0  	[0, 5)
 * 1  	[5, 10)
 * 2	[10, 20)
 * 3	[20, 30)
 * 4	[30, 40)
 * 5	[40, 50)
 * 6	[50, 60)
 * 7	[60, 70)
 * 8	[70, 80)
 * 9	[80, 90)
 * 10	[90, 95)
 * 11 	[95, 100]
 */

int get_battery_percent(int voltage, bool charge) // 剩余电量百分比
{
	if(voltage < 130 || voltage > 300) // 取值范围错误
	{
		return -1;
	}
	
	double real_voltage = voltage * 3.0 * 3.3 / 256.0; // 值=>电压 算法
	double real_capacity = 1.0;
	
	int charge_size = 0;
	int discharge_size = 0;
	
	int i = 0;
	
	int percent = 0;
	
	if (charge) // 充电
	{
		real_capacity = BATTERY_CHARGE_MAX;
		charge_size = sizeof(battery_charge_curve)/sizeof(battery_charge_curve[0]);
		
		for(i = 0; i < charge_size; i++)
		{
			if(real_voltage < battery_charge_curve[i].voltage)
			{
				real_capacity = battery_charge_curve[i].capacity;
				break;
			}
		}
		
		percent = real_capacity * 100.0 / BATTERY_CHARGE_CAPACITY;
	}
	else // 放电
	{
		real_capacity = BATTERY_DISCHARGE_CAPACITY;
		discharge_size = sizeof(battery_discharge_curve)/sizeof(battery_discharge_curve[0]);
		
		for(i = 0; i < discharge_size; i++)
		{
			if(real_voltage > battery_discharge_curve[i].voltage)
			{
				real_capacity = battery_discharge_curve[i].capacity;
				break;
			}
		}
		
		percent = (BATTERY_DISCHARGE_CAPACITY - real_capacity) * 100.0 / BATTERY_DISCHARGE_CAPACITY;
	}
	
	fprintf(stderr, "percent: %3d, charge: %1d, voltage: %3d, real_voltage: %f \n", 
		percent, charge, voltage, real_voltage);
	
	return percent;
}

char* get_battery_icon(int percent, bool charge)
{
	if(percent < 0 || percent > 100)
	{
		return NULL;
	}
	
	char *icon = NULL;
	
	if(charge)
	{
		icon = battery_charge_icon[percent];
	}
	else
	{
		icon = battery_discharge_icon[percent];
	}
	
	return icon;
}

